openapi: 3.0.3
info:
  title: Supplier API
  description: API for medical test suppliers to provide in order to allow Home Test platform integration
  version: 1.0.0

paths:
  /oauth/token:
    post:
      summary: OAuth 2.0 Token Endpoint
      description: Exchange client credentials for an access token
      tags:
        - Authentication
      security: []
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - grant_type
                - client_id
                - client_secret
              properties:
                grant_type:
                  type: string
                  enum: [client_credentials]
                  description: OAuth 2.0 grant type - must be 'client_credentials'
                  example: "client_credentials"
                client_id:
                  type: string
                  description: Client identifier assigned during registration
                  example: "supplier_client_abc123"
                client_secret:
                  type: string
                  description: Client secret assigned during registration
                  example: "client_secret_xyz789"
                scope:
                  type: string
                  description: Optional - requested scope (space-separated)
                  example: "orders results"
      responses:
        '200':
          description: Access token issued successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
                    description: The access token for API requests
                    example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                  token_type:
                    type: string
                    description: Token type - always 'Bearer'
                    example: "Bearer"
                  expires_in:
                    type: integer
                    description: Token lifetime in seconds
                    example: 3600
                  scope:
                    type: string
                    description: Granted scopes (space-separated)
                    example: "orders results"
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    enum: [invalid_request, invalid_client, invalid_grant, unsupported_grant_type]
                    example: "invalid_request"
                  error_description:
                    type: string
                    example: "The request is missing a required parameter"
        '401':
          description: Invalid client credentials
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "invalid_client"
                  error_description:
                    type: string
                    example: "Client authentication failed"

  /order:
    post:
      summary: Receive Test Order
      description: Receive a new test order from the home test platform
      tags:
        - Order Management
      parameters:
        - name: X-Correlation-ID
          in: header
          required: true
          description: Unique identifier for request tracking and idempotency
          schema:
            type: string
            format: uuid
            example: "550e8400-e29b-41d4-a716-446655440000"
      requestBody:
        required: true
        content:
          application/fhir+json:
            schema:
              $ref: '#/components/schemas/FHIRServiceRequest'
      responses:
        '201':
          description: Order received and processed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  order_uid:
                    type: string
                    format: uuid
                    description: Unique identifier for the order
                    example: "550e8400-e29b-41d4-a716-446655440000"
                  order_status:
                    type: string
                    description: Initial processing status
                    example: "RECEIVED"
                  estimated_delivery_date:
                    type: string
                    format: date
                    description: Expected delivery date for home delivery orders
                    example: "2025-11-07"
        '400':
          $ref: '#/components/responses/BadRequest'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'
        '409':
          description: Business rule conflict - order cannot be processed
          content:
            application/fhir+json:
              schema:
                $ref: '#/components/schemas/FHIROperationOutcome'
              examples:
                test_not_available:
                  summary: Test not available
                  value:
                    resourceType: "OperationOutcome"
                    issue:
                      - severity: "error"
                        code: "business-rule"
                        details:
                          text: "Test not available"
                        diagnostics: "The requested test is not available from this supplier"
                individual_quota_used:
                  summary: Individual quota already used
                  value:
                    resourceType: "OperationOutcome"
                    issue:
                      - severity: "error"
                        code: "business-rule"
                        details:
                          text: "Individual quota already used"
                        diagnostics: "Patient has already used their allocated quota for this test type"
                local_quota_exceeded:
                  summary: Local test quota exceeded
                  value:
                    resourceType: "OperationOutcome"
                    issue:
                      - severity: "error"
                        code: "business-rule"
                        details:
                          text: "Local test quota exceeded"
                        diagnostics: "Local authority test quota has been exceeded for this area"
                suspected_fraud:
                  summary: Suspected fraudulent order
                  value:
                    resourceType: "OperationOutcome"
                    issue:
                      - severity: "error"
                        code: "security"
                        details:
                          text: "Suspected fraudulent order"
                        diagnostics: "Order flagged for potential fraudulent activity and requires manual review"
                out_of_stock:
                  summary: Out of stock
                  value:
                    resourceType: "OperationOutcome"
                    issue:
                      - severity: "error"
                        code: "business-rule"
                        details:
                          text: "Out of stock"
                        diagnostics: "Test kit is currently out of stock at the requested location"
                not_eligible:
                  summary: Individual not eligible due to local authority rules
                  value:
                    resourceType: "OperationOutcome"
                    issue:
                      - severity: "error"
                        code: "business-rule"
                        details:
                          text: "Individual not eligible due to local authority rules"
                        diagnostics: "Patient does not meet local authority eligibility criteria for this test"

  /results:
    get:
      summary: Get Test Results
      description: Retrieve test results from the home test platform for completed orders
      tags:
        - Results Management
      parameters:
        - name: X-Correlation-ID
          in: header
          required: true
          description: Unique identifier for request tracking and idempotency
          schema:
            type: string
            format: uuid
            example: "550e8400-e29b-41d4-a716-446655440000"
        - name: order_uid
          in: query
          required: true
          description: Unique identifier of the order to get results for
          schema:
            type: string
            format: uuid
            example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        '200':
          description: Results retrieved successfully
          content:
            application/fhir+json:
              schema:
                type: object
                properties:
                  results:
                    type: array
                    items:
                      $ref: '#/components/schemas/FHIRObservation'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          description: No results found for the specified order
          content:
            application/problem+json:
              schema:
                type: object
                required:
                  - type
                  - title
                  - status
                properties:
                  type:
                    type: string
                    format: uri
                    description: Problem type URI
                    example: "https://hometest.nhs.uk/problems/results-not-found"
                  title:
                    type: string
                    description: Short, human-readable summary
                    example: "Results Not Found"
                  status:
                    type: integer
                    description: HTTP status code
                    example: 404
                  detail:
                    type: string
                    description: Human-readable explanation
                    example: "No test results were found for the specified order"
                  instance:
                    type: string
                    format: uri
                    description: URI identifying the specific problem occurrence
                    example: "/results/errors/001"

components:
  schemas:
    FHIRServiceRequest:
      type: object
      description: FHIR ServiceRequest resource for test orders
      required:
        - resourceType
        - status
        - intent
        - code
        - subject
        - requester
      properties:
        resourceType:
          type: string
          enum: [ServiceRequest]
          example: "ServiceRequest"
        id:
          type: string
          description: Logical id of this artifact
          example: "550e8400-e29b-41d4-a716-446655440000"
        intent:
          type: string
          description: Intent of the service request
          enum: [proposal, plan, directive, order, original-order, reflex-order, filler-order, instance-order, option]
          example: "order"
        code:
          type: object
          description: What is being requested/ordered (SNOMED CT)
          properties:
            coding:
              type: array
              items:
                type: object
                properties:
                  system:
                    type: string
                    example: "http://snomed.info/sct"
                  code:
                    type: string
                    example: "31676001"
                  display:
                    type: string
                    example: "HIV antibody test - self-sampling"
        subject:
          type: object
          description: Individual the service is ordered for
          properties:
            reference:
              type: string
              example: "Patient/123e4567-e89b-12d3-a456-426614174000"
            firstName:
              type: string
              description: Patient's first name
              example: "John"
            lastName:
              type: string
              description: Patient's last name
              example: "Smith"
            phone:
              type: string
              description: Patient's phone number
              example: "+447700900123"
            address:
              type: object
              description: Patient's address
              properties:
                line1:
                  type: string
                  description: First line of address
                  example: "123 Main Street"
                line2:
                  type: string
                  description: Second line of address (optional)
                  example: "Apartment 2B"
                city:
                  type: string
                  description: City or town
                  example: "London"
                postcode:
                  type: string
                  description: Postal code
                  example: "SW1A 1AA"
                country:
                  type: string
                  description: Country
                  example: "United Kingdom"
            email:
              type: string
              format: email
              description: Patient's email address
              example: "john.smith@example.com"
            dateOfBirth:
              type: string
              format: date
              description: Patient's date of birth
              example: "1985-03-15"
        requester:
          type: object
          description: Organization making the request
          properties:
            reference:
              type: string
              example: "Organization/ORG001"
        performer:
          type: array
          description: Requested performer (this supplier)
          items:
            type: object
            properties:
              reference:
                type: string
                example: "Organization/SUP001"

    FHIRObservation:
      type: object
      description: FHIR Observation resource for test results
      required:
        - resourceType
        - status
        - code
        - subject
      properties:
        resourceType:
          type: string
          enum: [Observation]
          example: "Observation"
        id:
          type: string
          description: Logical id of this artifact
          example: "obs-550e8400-e29b-41d4-a716-446655440000"
        basedOn:
          type: array
          description: Reference to the ServiceRequest this observation fulfills
          items:
            type: object
            properties:
              reference:
                type: string
                example: "ServiceRequest/550e8400-e29b-41d4-a716-446655440000"
        status:
          type: string
          description: Status of the observation result
          enum: [registered, preliminary, final, amended, corrected, cancelled, entered-in-error, unknown]
          example: "final"
        code:
          type: object
          description: Type of observation (SNOMED CT or LOINC)
          properties:
            coding:
              type: array
              items:
                type: object
                properties:
                  system:
                    type: string
                    example: "http://snomed.info/sct"
                  code:
                    type: string
                    example: "31676001"
                  display:
                    type: string
                    example: "HIV antibody test - self-sampling"
        subject:
          type: object
          description: Patient reference for matching with service request - PII removed for results
          required:
            - reference
          properties:
            reference:
              type: string
              description: Reference to patient for matching purposes only
              example: "Patient/123e4567-e89b-12d3-a456-426614174000"
        effectiveDateTime:
          type: string
          format: date-time
          description: When the observation was made
          example: "2025-11-04T15:45:00Z"
        issued:
          type: string
          format: date-time
          description: Date/Time this version was made available
          example: "2025-11-04T16:00:00Z"
        performer:
          type: array
          description: Who is responsible for the observation
          items:
            type: object
            properties:
              reference:
                type: string
                example: "Organization/SUP001"
        valueQuantity:
          type: object
          description: Actual result (for numeric results)
          properties:
            value:
              type: number
              example: 0.5
            unit:
              type: string
              example: "index"
            system:
              type: string
              example: "http://unitsofmeasure.org"
            code:
              type: string
              example: "1"
        valueCodeableConcept:
          type: object
          description: Actual result (for coded results)
          properties:
            coding:
              type: array
              items:
                type: object
                properties:
                  system:
                    type: string
                    example: "http://snomed.info/sct"
                  code:
                    type: string
                    example: "260415000"
                  display:
                    type: string
                    example: "Not detected"

    FHIROperationOutcome:
      type: object
      description: FHIR OperationOutcome resource for reporting errors and warnings
      required:
        - resourceType
        - issue
      properties:
        resourceType:
          type: string
          enum: [OperationOutcome]
          example: "OperationOutcome"
        id:
          type: string
          description: Logical id of this artifact
          example: "operation-outcome-001"
        issue:
          type: array
          description: Issues with the request or response
          minItems: 1
          items:
            type: object
            required:
              - severity
              - code
            properties:
              severity:
                type: string
                description: Severity of the issue
                enum: [fatal, error, warning, information]
                example: "error"
              code:
                type: string
                description: Error or warning code
                enum: [invalid, structure, required, value, invariant, security, login, unknown, expired, forbidden, suppressed, processing, not-supported, duplicate, multiple-matches, not-found, deleted, too-long, code-invalid, extension, too-costly, business-rule, conflict, transient, lock-error, no-store, exception, timeout, incomplete, throttled, informational]
                example: "invalid"
              details:
                type: object
                description: Additional details about the error
                properties:
                  coding:
                    type: array
                    items:
                      type: object
                      properties:
                        system:
                          type: string
                          example: "http://terminology.hl7.org/CodeSystem/operation-outcome"
                        code:
                          type: string
                          example: "MSG_PARAM_INVALID"
                        display:
                          type: string
                          example: "Parameter 'postcode' content is invalid"
                  text:
                    type: string
                    example: "Invalid postcode format provided"
              diagnostics:
                type: string
                description: Additional diagnostic information
                example: "Postcode must be in UK format (e.g., SW1A 1AA)"
              location:
                type: array
                description: Xpath or JSONPath of element with error
                items:
                  type: string
                example: ["postcode"]
              expression:
                type: array
                description: FHIRPath of element with error
                items:
                  type: string
                example: ["postcode"]
  responses:
    BadRequest:
      description: Bad request - invalid parameters
      content:
        application/problem+json:
          schema:
            type: object
            required:
              - type
              - title
              - status
            properties:
              type:
                type: string
                format: uri
                description: Problem type URI
                example: "https://hometest.nhs.uk/problems/validation-error"
              title:
                type: string
                description: Short, human-readable summary
                example: "Validation Error"
              status:
                type: integer
                description: HTTP status code
                example: 400
              detail:
                type: string
                description: Human-readable explanation
                example: "The request contains invalid data that cannot be processed"
              instance:
                type: string
                format: uri
                description: URI identifying the specific problem occurrence
                example: "/order/errors/001"

    UnprocessableEntity:
      description: Unprocessable entity - validation errors
      content:
        application/problem+json:
          schema:
            type: object
            required:
              - type
              - title
              - status
            properties:
              type:
                type: string
                format: uri
                description: Problem type URI
                example: "https://hometest.nhs.uk/problems/fhir-validation-error"
              title:
                type: string
                description: Short, human-readable summary
                example: "FHIR Validation Error"
              status:
                type: integer
                description: HTTP status code
                example: 422
              detail:
                type: string
                description: Human-readable explanation
                example: "The FHIR resource contains validation errors and cannot be processed"
              instance:
                type: string
                format: uri
                description: URI identifying the specific problem occurrence
                example: "/order/errors/002"
              errors:
                type: array
                description: Detailed validation errors
                items:
                  type: object
                  properties:
                    field:
                      type: string
                      example: "subject.identifier.value"
                    message:
                      type: string
                      example: "Date of Birth is required"

  securitySchemes:
    OAuth2ClientCredentials:
      type: oauth2
      description: OAuth 2.0 Client Credentials flow for supplier authentication
      flows:
        clientCredentials:
          tokenUrl: /oauth/token
          scopes:
            orders: Access to order management endpoints
            results: Access to results endpoints
    SupplierAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token issued to verified suppliers via OAuth 2.0

security:
  - OAuth2ClientCredentials: [orders, results]
  - SupplierAuth: []