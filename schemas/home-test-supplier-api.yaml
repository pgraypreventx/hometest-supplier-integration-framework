openapi: 3.0.3
info:
  title: Home Test Supplier API
  description: API for supplier domain operations - managing test results and order status updates
  version: 1.0.4

paths:
  /result:
    post:
      summary: Post Test Results
      description: Submit test results for a completed order
      tags:
        - Result Service
      parameters:
        - name: X-Correlation-ID
          in: header
          required: true
          description: Unique identifier for request tracking and idempotency
          schema:
            type: string
            format: uuid
            example: "550e8400-e29b-41d4-a716-446655440000"
      requestBody:
        required: true
        content:
          application/fhir+json:
            schema:
              $ref: '#/components/schemas/FHIRObservation'
      responses:
        '201':
          description: Results posted successfully
          content:
            application/fhir+json:
              schema:
                $ref: '#/components/schemas/FHIRObservation'
              example:
                resourceType: "Observation"
                id: "550e8400-e29b-41d4-a716-446655440001"
                basedOn:
                  - reference: "ServiceRequest/550e8400-e29b-41d4-a716-446655440000"
                status: "final"
                code:
                  coding:
                    - system: "http://snomed.info/sct"
                      code: "31676001"
                      display: "HIV antigen test"
                  text: "HIV antigen test"
                subject:
                  reference: "Patient/123e4567-e89b-12d3-a456-426614174000"
                effectiveDateTime: "2025-11-04T15:45:00Z"
                issued: "2025-11-04T16:00:00Z"
                performer:
                  - reference: "Organization/SUPP001"
                    display: "Test Supplier Ltd"
                valueCodeableConcept:
                  coding:
                    - system: "http://snomed.info/sct"
                      code: "260415000"
                      display: "Not detected"
                interpretation:
                  - coding:
                      - system: "http://terminology.hl7.org/CodeSystem/v3-ObservationInterpretation"
                        code: "N"
                        display: "Normal"
                    text: "Normal"
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /test-order/status:
    put:
      summary: Update Order Status
      description: Update the status of an existing order using FHIR Task resource
      tags:
        - Order Management
      parameters:
        - name: X-Correlation-ID
          in: header
          required: true
          description: Unique identifier for request tracking and idempotency
          schema:
            type: string
            format: uuid
            example: "550e8400-e29b-41d4-a716-446655440000"
      requestBody:
        required: true
        content:
          application/fhir+json:
            schema:
              $ref: '#/components/schemas/FHIRTask'
      responses:
        '200':
          description: Status updated successfully
          content:
            application/fhir+json:
              schema:
                $ref: '#/components/schemas/FHIRTask'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'

components:
  schemas:
    FHIRObservation:
      type: object
      description: FHIR Observation resource for test results
      required:
        - resourceType
        - status
        - code
        - subject
        - basedOn
        - valueCodeableConcept
      properties:
        resourceType:
          type: string
          enum: [Observation]
          example: "Observation"
        id:
          type: string
          description: Logical id of this artifact
          example: "550e8400-e29b-41d4-a716-446655440001"
        basedOn:
          type: array
          description: Reference to the ServiceRequest this observation fulfills
          items:
            $ref: '#/components/schemas/FHIRReference'
        status:
          type: string
          description: Status of the observation result
          enum: [registered, preliminary, final, amended, corrected, cancelled, entered-in-error, unknown]
          example: "final"
        code:
          allOf:
            - $ref: '#/components/schemas/FHIRCodeableConcept'
            - description: Type of observation (SNOMED CT or LOINC)
              example:
                coding:
                  - system: "http://snomed.info/sct"
                    code: "31676001"
                    display: "HIV antigen test"
                text: "HIV antigen test"
        subject:
          allOf:
            - $ref: '#/components/schemas/FHIRReference'
            - description: Patient reference for matching with service request - PII removed for results
              example:
                reference: "Patient/123e4567-e89b-12d3-a456-426614174000"
        effectiveDateTime:
          type: string
          format: date-time
          description: When the observation was made
          example: "2025-11-04T15:45:00Z"
        issued:
          type: string
          format: date-time
          description: Date/Time this version was made available
          example: "2025-11-04T16:00:00Z"
        performer:
          type: array
          description: Who is responsible for the observation
          items:
            $ref: '#/components/schemas/FHIRReference'
        interpretation:
          type: array
          description: Clinical interpretation of the observation (e.g., Normal, Abnormal, Positive, Negative)
          items:
            $ref: '#/components/schemas/FHIRCodeableConcept'
        valueCodeableConcept:
          allOf:
            - $ref: '#/components/schemas/FHIRCodeableConcept'
            - description: Actual result (for coded results)
              example:
                coding:
                  - system: "http://snomed.info/sct"
                    code: "260415000"
                    display: "Not detected"

    FHIRTask:
      type: object
      description: FHIR Task resource for tracking order status
      required:
        - resourceType
        - status
        - intent
        - basedOn
        - identifier
      properties:
        resourceType:
          type: string
          enum: [Task]
          example: "Task"
        id:
          type: string
          description: Logical id of this artifact
          example: "task-550e8400-e29b-41d4-a716-446655440000"
        identifier:
          type: array
          description: Task Instance Identifier
          items:
            $ref: '#/components/schemas/FHIRIdentifier'
        basedOn:
          type: array
          description: Request fulfilled by this task
          items:
            $ref: '#/components/schemas/FHIRReference'
        status:
          type: string
          description: Current status of the task - FHIR standard values (use businessStatus for domain-specific states)
          enum: [draft, requested, received, accepted, rejected, ready, cancelled, in-progress, on-hold, failed, completed, entered-in-error]
          example: "in-progress"
        intent:
          type: string
          description: Indicates the "level" of actionability associated with the Task
          enum: [unknown, proposal, plan, order, original-order, reflex-order, filler-order, instance-order, option]
          example: "order"
        statusReason:
          allOf:
            - $ref: '#/components/schemas/FHIRCodeableConcept'
            - description: Reason for current status
              example:
                text: "Sample collected and being processed"
        for:
          allOf:
            - $ref: '#/components/schemas/FHIRReference'
            - description: Beneficiary of the Task
              example:
                reference: "Patient/123e4567-e89b-12d3-a456-426614174000"
        authoredOn:
          type: string
          format: date-time
          description: Task Creation Date
          example: "2025-11-04T10:30:00Z"
        lastModified:
          type: string
          format: date-time
          description: Task Last Modified Date
          example: "2025-11-04T10:35:00Z"
        requester:
          allOf:
            - $ref: '#/components/schemas/FHIRReference'
            - description: Who is asking for task to be done
              example:
                reference: "Organization/ORG001"
        owner:
          allOf:
            - $ref: '#/components/schemas/FHIRReference'
            - description: Responsible individual for the task
              example:
                reference: "Organization/SUP001"
        businessStatus:
          allOf:
            - $ref: '#/components/schemas/FHIRCodeableConcept'
            - description: Domain-specific business status (e.g., "order-received", "dispatched", "received-at-lab", "complete")
              example:
                text: "dispatched"

    FHIROperationOutcome:
      type: object
      description: FHIR OperationOutcome resource for reporting errors and warnings
      required:
        - resourceType
        - issue
      properties:
        resourceType:
          type: string
          enum: [OperationOutcome]
          example: "OperationOutcome"
        id:
          type: string
          description: Logical id of this artifact
          example: "operation-outcome-001"
        issue:
          type: array
          description: Issues with the request or response
          minItems: 1
          items:
            type: object
            required:
              - severity
              - code
            properties:
              severity:
                type: string
                description: Severity of the issue
                enum: [fatal, error, warning, information]
                example: "error"
              code:
                type: string
                description: Error or warning code
                enum: [invalid, structure, required, value, invariant, security, login, unknown, expired, forbidden, suppressed, processing, not-supported, duplicate, multiple-matches, not-found, deleted, too-long, code-invalid, extension, too-costly, business-rule, conflict, transient, lock-error, no-store, exception, timeout, incomplete, throttled, informational]
                example: "invalid"
              details:
                allOf:
                  - $ref: '#/components/schemas/FHIRCodeableConcept'
                  - description: Additional details about the error
                    example:
                      text: "Invalid parameter provided"
              diagnostics:
                type: string
                description: Additional diagnostic information
                example: "The request contains invalid data that cannot be processed"
              location:
                type: array
                description: Xpath or JSONPath of element with error
                items:
                  type: string
                example: ["Observation.status"]
              expression:
                type: array
                description: FHIRPath of element with error
                items:
                  type: string
                example: ["Observation.status"]

    FHIRReference:
      type: object
      description: A reference from one resource to another (FHIR Reference datatype)
      required:
        - reference
      properties:
        reference:
          type: string
          description: Literal reference, Relative, internal or absolute URL
          example: "Organization/SUP001"
        type:
          type: string
          description: Type the reference refers to (e.g., "Organization")
          example: "Organization"
        display:
          type: string
          description: Text alternative for the resource
          example: "Supplier Organization Name"
    FHIRCodeableConcept:
      type: object
      description: A CodeableConcept represents a value that is usually supplied by providing a reference to one or more terminologies or ontologies (FHIR CodeableConcept datatype)
      properties:
        coding:
          type: array
          description: Code defined by a terminology system
          items:
            $ref: '#/components/schemas/FHIRCoding'
        text:
          type: string
          description: Plain text representation of the concept
          example: "HIV antigen test"
    FHIRCoding:
      type: object
      description: A Coding is a representation of a defined concept using a symbol from a defined code system (FHIR Coding datatype)
      properties:
        system:
          type: string
          description: Identity of the terminology system
          example: "http://snomed.info/sct"
        code:
          type: string
          description: Symbol in syntax defined by the system
          example: "31676001"
        display:
          type: string
          description: Representation defined by the system
          example: "HIV antigen test"
    FHIRIdentifier:
      type: object
      description: An identifier intended for computation (FHIR Identifier datatype)
      properties:
        system:
          type: string
          description: The namespace for the identifier value
          example: "https://fhir.hometest.nhs.uk/Id/order-uid"
        value:
          type: string
          description: The value that is unique within the system
          example: "550e8400-e29b-41d4-a716-446655440000"
        use:
          type: string
          description: The purpose of this identifier
          enum: [usual, official, temp, secondary, old]
          example: "official"

  responses:
    BadRequest:
      description: Bad request - invalid parameters
      content:
        application/fhir+json:
          schema:
            $ref: '#/components/schemas/FHIROperationOutcome'
          example:
            resourceType: "OperationOutcome"
            issue:
              - severity: "error"
                code: "invalid"
                details:
                  text: "Validation Error"
                diagnostics: "The request contains invalid data that cannot be processed"

    Unauthorized:
      description: Unauthorized - invalid or missing authentication
      content:
        application/fhir+json:
          schema:
            $ref: '#/components/schemas/FHIROperationOutcome'
          example:
            resourceType: "OperationOutcome"
            issue:
              - severity: "error"
                code: "login"
                details:
                  text: "Authentication Required"
                diagnostics: "Valid authentication credentials are required to access this resource"

    NotFound:
      description: Resource not found
      content:
        application/fhir+json:
          schema:
            $ref: '#/components/schemas/FHIROperationOutcome'
          example:
            resourceType: "OperationOutcome"
            issue:
              - severity: "error"
                code: "not-found"
                details:
                  text: "Resource Not Found"
                diagnostics: "The requested order could not be found"

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
    NHS_Login:
      type: oauth2
      flows:
        authorizationCode:
          authorizationUrl: https://auth.nhs.uk/oauth2/authorize
          tokenUrl: https://auth.nhs.uk/oauth2/token
          scopes:
            read: Read access to test information
            write: Write access to create orders
            admin: Administrative access

security:
  - BearerAuth: []
  - NHS_Login: []